# stt-raspi

## Setup
### Setup both with one command (for tesing)

```bash
make install_all
```
This will however not set it up a as a service, so you will have to run the
command separately.

### Server
Look into the Makefile
Generally there are 2 main things to setup: either vosk or efficient-word-net
- for vosk:
```bash
make install_vosk
```

It is intended for the server to be ran a as a service, so you can use the
Makefile to start it: if setup this way it will be using your current user as
the service user, the models are always located in `~/.local/share/vosk/models/`
the server script will be at `~/.local/share/vosk/server.py` and the
`server_config.json` file will be at `~/.local/share/vosk/server_config.json`.

```bash
make setup_service # this will setup the systemd service
```
- Example config:
```json
{ "modelpath": "~/.local/share/vosk/models/vosk-model-small-en-us-0.15",
    "port": 2700,
    "sample_rate": 16000,
    "spkmodel": ""
}
```
- Explaination:
    - "modelpath" - path to the Vosk model, this is the path to the model that
      you want to use for speech recognition, it should be a directory that
      contains the model files.
    - "port" - port to run the server on, default is 2700, this is the port that
      the client will connect to.
    - "sample_rate" - sample rate of the audio, this should match the sample
      rate of the audio that you are sending to the server, default is 16000.
    - "spkmodel" - path to the speaker model, this is optional and can be left
      empty if you don't want to use speaker recognition.

### Client
- for efficient-word-net: 
```bash
make install_eff_word
```

Since this is intened to be used as a module of a larger applicaiton, setting it
up as a service directly is not recommended. Similar setup to the server, the
config file must be in the same directory as the server script.

```json
{
    "debug" : 0,
    "hotword_threshold" : 0.6,
    "relaxation_time" : 2,
    "hotword" : "mycroft",
    "hotword_refference_file" : "~/.local/lib/python3.9/site-packages/eff_word_net/sample_refs/mycroft_ref.json",
    "server" : "ws://localhost:2700",
    "sample_rate_to_server" : 16000
}
```
- Explaination:
    - "debug" - either 1 or zero if you want debug output (recording, wakeword
      accuracy, stop recording)
    - "hotword_threshold" - threshhold fir confidence when the hotword is
      spoken, .6 is good durrign testing,,
    - "relaxation_time" - minimum time in seconds to wait before listening for
      the hotword again after it has been spoken, this is useful to avoid
      triggering the hotword multiple times in a row, default is 2 seconds.
    - "hotword" - hotword to listen for, this is the word that will be used to
      trigger the wakeword currently available: `alexa`, `computer`,
      `lights_on`, `mycroft`, `balloon`, `lights_off`, `mobile`, custom words
      are also possible, see the section below on how to create a custom
      hotword.
    - "hotword_refference_file" - file that is the model for that hotword, this
      is generated by the `eff_word_net` CLI tool, it is a json file that
      contains the reference audio samples for the hotword.
    - "server" - the server address to connect to, this is the address of the
      Vosk server that is running on the Raspberry Pi, it is a websocket address
      and should be in the format `ws://<ip>:<port>`, by default it is
      `ws://localhost:2700`
    - "sample_rate_to_server" - the sample rate to send to the server, this
      should match the sample rate of the Vosk server, by default it is 16000

### Client with custom hotword
- Create a custom hotword reference file using the `eff_word_net` CLI tool:

https://ttsmaker.com/ is not a bad place to make some machine generated record the samples with varying pitches, about 6-7 is good.
And then use the built in cli tool to generate the reference file.
There is a makefile in the custom word directory.
Also with this approach keep the threshhold low, like .5 is lright with this
approach.

``` bash
# this will generate a reference file for the hotword "rosko" 
# using the audio in ./audio-custom and the output will be 
# in the ./out directory
python3.9 -m eff_word_net.generate_reference \
        --input-dir=./audio-custom \
        --output-dir=./out \
        --wakeword="rosko" \
        --model-type="resnet_50_arc" 
```
- with a `client_settings.json` looking like tis
```json
{
    "debug" : 1,
    "hotword_threshold" : 0.5,
    "relaxation_time" : 2,
    "hotword" : "rosko",
    "hotword_refference_file" : "/home/pi/stt-raspi/vosk-client-hotword/custom-word/out/rosko_ref.json",
    "server" : "ws://localhost:2700",
    "sample_rate_to_server" : 16000
}
```

## Usage
### Server
- Run the server script:
```bash
python3.9 PROJECT_ROOT/vosk-server/server.py
# or alternatively have it setup as a service and dont boter runnign it manually
```

- Running the cleint script:
```bash
# simple client
python3.9 PROJECT_ROOT/vosk-client-hotword/simple/vosk_client_hotword.py
# or
python3.9 PROJECT_ROOT/vosk-client-hotword/custom-word/vosk_client_hotword.py
```
